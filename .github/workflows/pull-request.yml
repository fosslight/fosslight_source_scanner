# Running tests with tox for releasing new version

name: Pull requests fosslight_source_scanner

on:
  pull_request:
    branches:
      - '*'

jobs:
  check-commit-message:
    uses: fosslight/.github/.github/workflows/base-check-commit-message.yml@main
    secrets:
      envPAT: ${{ secrets.GITHUB_TOKEN }}

  build:
    strategy:
      matrix:
        python-version: ["3.11"]
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install tox
    - name: Run Tox
      run: |
        tox -e release
  build_macos:
    strategy:
      matrix:
        python-version: ["3.11"]
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: |
        if ! brew list openssl@3 &>/dev/null; then
            brew install openssl@3
        fi
        brew install libmagic
        brew install postgresql
        python -m pip install --upgrade pip
        pip install tox
    - name: Run Tox
      run: |
        tox -e release

  reuse:
    runs-on: ubuntu-latest
    steps: 
    - uses: actions/checkout@v3
    - name: REUSE Compliance Check
      uses: fsfe/reuse-action@v1

  pr-review:
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get diff
        id: diff
        run: |
          git diff "${{ github.event.pull_request.base.sha }}" "${{ github.event.pull_request.head.sha }}" -- . > diff.txt
          echo "size=$(wc -c < diff.txt)" >> $GITHUB_OUTPUT
      - name: Skip if no code change
        id: skip
        run: |
          if [ "${{ steps.diff.outputs.size }}" -lt 5 ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
      - name: Request review from service
        id: review
        if: steps.skip.outputs.skip != 'true'
        env:
          SERVICE_URL: ${{ secrets.PR_REVIEW_SERVICE_URL }}
        run: |
          echo '{"pr_title": ${{ toJSON(github.event.pull_request.title) }}, "pr_body": ${{ toJSON(github.event.pull_request.body) }}}' > meta.json
          jq -n --rawfile diff diff.txt --slurpfile m meta.json '$m[0] + {diff: $diff}' > payload.json
          BODY=$(curl -sf --max-time 660 -X POST "${SERVICE_URL}/review" \
            -H "Content-Type: application/json" \
            -d @payload.json \
            | jq -r .body) || true
          echo "## ğŸ¤– LLM ë¦¬ë·° ìš”ì•½" > review_body.md
          echo "" >> review_body.md
          echo "${BODY:-ë¦¬ë·° ìƒì„±ì— ì‹¤íŒ¨í–ˆê±°ë‚˜ ì‘ë‹µì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.}" >> review_body.md
      - name: Post review comment
        if: steps.skip.outputs.skip != 'true' && success()
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.TOKEN || secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body-path: review_body.md
          edit-mode: replace
      - name: Comment when no code change
        if: steps.skip.outputs.skip == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.TOKEN || secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: "## ğŸ¤– LLM ë¦¬ë·° ìš”ì•½\n\nì´ PRì—ëŠ” ë¦¬ë·°í•  ì½”ë“œ ë³€ê²½ì´ ì—†ìŠµë‹ˆë‹¤."
          edit-mode: replace
